---
title: "Untitled"
output: html_document
date: "2025-04-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
#For Camila (updated 3/4/25)
library(openxlsx)
library(ggplot2)
library(data.table)
library(tidyr)
library(ggpval)
library(ggprism)
library(patchwork)
library(magrittr)
library(dplyr)
library(tidyverse)
library(rstatix)
library(ggpubr)
library(RColorBrewer)
library(ggpattern)
library(stringr)
library(viridis)
```


```{r}
save_Location <- 'D:/Camila/Ca imaging TRPA1 UTRs replicates/TRPA1_UTR_Results_dp_7_10_25/'

df1 <- read.csv(paste0(save_Location, "TRPA1_UTR_dp_7_10_25CalciumExpressingCells.csv"))
 

df1 <- df1[, c("FileName_Cell", "ImageNumber", "Intensity_MeanIntensity_OrigGreen", "Intensity_IntegratedIntensity_OrigGreen",  "Intensity_MedianIntensity_OrigGreen")]

sub_df2 <- df1 %>% separate(FileName_Cell, into = c("BiologicalRep", "Condition", "FileName2"), sep = "_")

sub_df2$BiologicalRep <- str_sub(sub_df2$BiologicalRep, start = -1)
sub_df2$Time <- str_sub(sub_df2$FileName2, start = -7, end = -5)
sub_df2$Replicate <- str_sub(sub_df2$FileName2, start = 1, end = 1)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
#Subtract by average of lowest 1% of cells
# sub_df2 <- sub_df2 %>%
#   group_by(Time, Replicate, BiologicalRep) %>%
#   mutate(
#     # Calculate the threshold for bottom 25% of cells for green intensity (to account for transfection efficiency)
#     #ratioThreshold = mean(sort(Intensity_MeanIntensity_OrigGreen)[1:ceiling(0.001 * n())], na.rm = TRUE),
# 
#     # Subtract by the threshold
#     #Intensity_MeanIntensity_OrigGreen = Intensity_MeanIntensity_OrigGreen - ratioThreshold,
#     Intensity_MeanIntensity_OrigGreen =  Intensity_MeanIntensity_OrigGreen
#   )
#  

# View the result
sub_df2 <- sub_df2[sub_df2$Intensity_MeanIntensity_OrigGreen != Inf, ]

sub_df2 <- sub_df2[sub_df2$Intensity_MeanIntensity_OrigGreen > 0, ]

#Make a binary expressed vs non-expressed readout
#sub_df2$BinaryActive <- sub_df2 %>%  mutate(across(Intensity_MeanIntensity_OrigGreen, ~ ifelse(. >=0.1, 1, 0))) %>% pull(Intensity_MeanIntensity_OrigGreen)
#This will total up the number of expressing cells foreach replicates 005 timepoint (grouped by biologicalrep, condition, and technicalrep):
sub_df2 <- sub_df2 %>% group_by(BiologicalRep, Condition, Replicate) %>% mutate(ExpressingOriginalTimepoint = sum(Time == "005"))

#USE THIS:
##################
#Use this most likely:
results <- sub_df2 %>%
  group_by(across(c(Time, Condition, BiologicalRep, Replicate))) %>%
  arrange(desc(Intensity_MeanIntensity_OrigGreen), .by_group = TRUE) %>%
  mutate(row_num = row_number()) %>%
  filter(row_num > ExpressingOriginalTimepoint) %>%
  #slice_head(n = 500) %>%
   summarize(
    Avg_IntensityperCell = mean(Intensity_MeanIntensity_OrigGreen, na.rm = TRUE),
    # median_Ratio = median(Intensity_MeanIntensity_OrigGreen, na.rm = TRUE),
    Summation_ofIntegratedIntensityperImage = sum(Intensity_MeanIntensity_OrigGreen, na.rm = TRUE),

    ExpressingCells = n())

#Note: Changed this from mean_Ratio to just the number of expressed cells.
 results_summary_AcrossRep <- results %>%
  group_by(Time, Condition, BiologicalRep) %>%
  summarise(NumberofExpressingCells_AvgReplicate = mean(ExpressingCells), SD = (sd(ExpressingCells)) )
 
 results <- merge(results, results_summary_AcrossRep, by = c("BiologicalRep","Condition", "Time"))
 
#  
results_summary_AcrossBio <- results_summary_AcrossRep %>%
  group_by(Time, Condition) %>%
  summarise(NumberofExpressingCells_AvgBiologicalReplicate = mean(NumberofExpressingCells_AvgReplicate), SE = (sd(NumberofExpressingCells_AvgReplicate) / sqrt(3)))

results <- merge(results, results_summary_AcrossBio, by = c("Condition", "Time"))

 
```

```{r}

barPlot_Fig <- ggplot(results, aes(x = Condition, y = NumberofExpressingCells_AvgBiologicalReplicate, fill = Time,)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.5, alpha = 0.6, fill = "gray", color = "black") +
  
  geom_errorbar(aes(ymin = NumberofExpressingCells_AvgBiologicalReplicate - SE, ymax = NumberofExpressingCells_AvgBiologicalReplicate + SE), 
                position = position_dodge(width = 0.8), width = 0.4) +
  
   geom_point(data = results, aes(x = Condition, y = NumberofExpressingCells_AvgReplicate, group = Time, color = BiologicalRep),
             position = position_jitterdodge(jitter.width = 0, dodge.width = 0.8),
             size = 3, alpha = 0.99, show.legend = TRUE) +

    theme_classic() +
  #labs(y = "Ratio (340/380 [nm]: Green Channel)", title = "TRPA1 UTRs Promoters: Number of Expressing Cells") + 
  labs(y = "Summation of Integrated Intensity", title = "TRPA1 UTRs Promoters: Total Integrated Intensity") + 

  theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5)) +
  theme(axis.title.y = element_text(size = 18), axis.title.x = element_blank()) +
  theme(axis.text.x = element_text(size = 18, angle = 55, hjust = 1)) +
  
  labs(fill = " ") +
  # scale_fill_brewer(palette = "Set1") + 
  # scale_color_brewer(palette = "Set1") +  # Adjust color palette for Replicate
  coord_cartesian(ylim = c(0, max(results$NumberofExpressingCells_AvgBiologicalReplicate + results$SE + 10)))+
  scale_fill_viridis(discrete = TRUE, option = "C", direction = -1,  begin = 0.2, end = 0.6) +
  scale_color_manual(values = c("red",  "black", "green", "blue"))
  

# Adjust y-axis limits

# Display the plot
print(barPlot_Fig)

ggsave(paste0(save_Location, "TRPA1_UTRs_7_11_2025_dp_CellCount_UPDATED.pdf"), barPlot_Fig, width = 10, height = 10)

wb <- createWorkbook()
#OR if file is already created:
#wb <- loadWorkbook(save_Location)
addWorksheet(wb, "BiologicalReplicate")
addWorksheet(wb, "TechnicalReplicate")
addWorksheet(wb, "RawData")

writeData(wb, sheet = "BiologicalReplicate", x = results_summary_AcrossBio, startCol = 1, startRow = 1)
writeData(wb, sheet = "TechnicalReplicate", x = results_summary_AcrossRep, startCol = 1, startRow = 1)
writeData(wb, sheet = "RawData", x = results, startCol = 1, startRow = 1)

saveWorkbook(wb, paste0(save_Location, "TRPA1_UTRs_7_11_2025_dp_CellCount_UPDATED.xlsx"), overwrite = T)


```

```{r}


boxPlot_Fig <- ggboxplot(
  sub_df2, 
  x = "Condition", 
  y = "Intensity_MeanIntensity_OrigGreen", 
  fill = "Time", 
  color = "black", # Change to black outline for better visibility
  alpha = 0.6, # Slightly transparent boxes
  width = 0.7, 
  outlier.shape = NA,
  palette = "npg" # Use a publication-ready color palet# Make sure boxes are dodged consistently
) + 
  # Add points with biological replicate coloring
  geom_point(
    position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.8), 
    aes(color = Replicate, group = interaction(Time, Condition)), 
    size = 0.2, 
    alpha = 0.8,
    show.legend = TRUE
  ) +
  # Add better legends
  labs(y = "Ratio (340/380 [nm]: Green Channel)", title = "TRPV1 Promoters; Top 500 Cells, Replicate Mean:") + 
  labs(fill = "Time", color = "Replicate") +
  # Use a color palette suitable for categorical data
  scale_color_brewer(palette = "Dark2") +
  # Improve theme
  theme_classic() +
      theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5)) +
  theme(axis.title.y = element_text(size = 18), axis.title.x = element_blank()) +
  theme(axis.text.x = element_text(size = 18, angle = 55, hjust = 1)) +
  
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    legend.position = "right"
  )

print(boxPlot_Fig)

ggsave(paste0(save_Location, "TRPV1_Promoters_3_27_25_dpAllCellsBoxPlot.PDF"), boxPlot_Fig, width = 10, height = 10)




```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
